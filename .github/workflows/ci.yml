name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ci-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  TINYGO_VERSION: "0.40.1"

jobs:
  lint:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.x"

      - name: Vet
        run: go vet ./...

      - name: Lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.10

      - name: Check go mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod
          if [ -f go.sum ]; then git diff --exit-code go.sum; fi

      - name: Govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Validate scripts
        run: |
          bash -n scripts/setup.sh
          bash -n scripts/create-vm.sh
          bash -n scripts/e2e.sh

      - name: Check documentation links
        run: |
          broken=0
          while IFS= read -r md; do
            dir=$(dirname "$md")
            while IFS= read -r link; do
              link=$(echo "$link" | sed 's/#.*//')
              if [ -n "$link" ] && [ ! -e "$dir/$link" ]; then
                echo "::error file=$md::broken link: $link"
                broken=1
              fi
            done < <(grep -oE '\]\([^)]+\)' "$md" | sed -E 's/^\]\(//;s/\)$//' | grep -v '^http' | grep -v '^#')
          done < <(find . -name '*.md' -not -path './.git/*')
          exit $broken

      - name: Validate GoReleaser config
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: check

      - name: Audit support matrix
        run: |
          status=0
          for gv in 1.24 1.25; do
            if ! grep -q "${gv}" docs/SUPPORT_MATRIX.md; then
              echo "::error::Go ${gv}.x tested in CI but not in docs/SUPPORT_MATRIX.md"
              status=1
            fi
          done
          for lv in 20 21; do
            if ! grep -q "LLVM.*${lv}" docs/SUPPORT_MATRIX.md; then
              echo "::error::LLVM ${lv} tested in CI but not in docs/SUPPORT_MATRIX.md"
              status=1
            fi
          done
          exit $status

  test:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        go-version: ["1.24.x", "1.25.x"]
        llvm-version: ["20", "21"]
        include:
          - go-version: "1.25.x"
            llvm-version: "20"
            primary: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}

      - name: Install LLVM toolchain
        run: |
          codename=$(lsb_release -cs)
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc > /dev/null
          echo "deb http://apt.llvm.org/${codename}/ llvm-toolchain-${codename}-${{ matrix.llvm-version }} main" | sudo tee /etc/apt/sources.list.d/llvm-${{ matrix.llvm-version }}.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq llvm-${{ matrix.llvm-version }}
          echo "/usr/lib/llvm-${{ matrix.llvm-version }}/bin" >> "$GITHUB_PATH"

      - name: Install TinyGo
        run: |
          wget -qO /tmp/tinygo.deb "https://github.com/tinygo-org/tinygo/releases/download/v${TINYGO_VERSION}/tinygo_${TINYGO_VERSION}_amd64.deb"
          sudo dpkg -i /tmp/tinygo.deb

      - name: Generate fresh IR fixture
        if: matrix.primary
        run: |
          cd examples/tracepoint-connect
          tinygo build -gc=none -scheduler=none -panic=trap -opt=1 -o ../../testdata/tinygo_probe.ll ./bpf

      - name: Print versions
        run: |
          echo "=== Toolchain ==="
          echo "Go:     $(go version)"
          if command -v tinygo >/dev/null 2>&1; then echo "TinyGo: $(tinygo version)"; fi
          echo "LLVM:   $(llvm-link --version 2>&1 | head -1)"
          echo "opt:    $(opt --version 2>&1 | head -1)"
          echo "llc:    $(llc --version 2>&1 | head -1)"

      - name: Test
        run: go test -race -timeout 5m ./...

      - name: Build
        run: CGO_ENABLED=0 go build -ldflags "-s -w" -trimpath -o tinybpf ./cmd/tinybpf

      - name: Binary size
        if: matrix.primary
        run: |
          size=$(stat --format=%s tinybpf)
          echo "Binary size: $(numfmt --to=iec $size)"
          max=$((15 * 1024 * 1024))
          if [ "$size" -gt "$max" ]; then
            echo "::error::Binary size ${size} exceeds ${max} byte threshold"
            exit 1
          fi

      - name: Coverage
        if: matrix.primary
        run: |
          go test -coverprofile=coverage.out ./...
          total=$(go tool cover -func=coverage.out | grep ^total: | awk '{print $3}' | tr -d '%')
          echo "Coverage: ${total}%"
          threshold=90
          if [ "$(echo "${total} < ${threshold}" | bc -l)" -eq 1 ]; then
            echo "::error::Coverage ${total}% is below ${threshold}% threshold"
            exit 1
          fi

      - name: Cache fuzz corpus
        if: matrix.primary
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build/fuzz
          key: fuzz-${{ runner.os }}-${{ hashFiles('internal/transform/*_test.go') }}
          restore-keys: fuzz-${{ runner.os }}-

      - name: Fuzz smoke
        if: matrix.primary
        run: |
          fuzz_targets=$(grep -r '^func Fuzz' internal/transform/ --include='*_test.go' -l | sort -u)
          for file in $fuzz_targets; do
            dir=$(dirname "$file")
            for target in $(grep -oP '^func \KFuzz\w+' "$file"); do
              echo "--- fuzzing $target (10s) ---"
              go test "./$dir" -run "^${target}\$" -fuzz "^${target}\$" -fuzztime 10s -timeout 30s
            done
          done

  bench:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.x"

      - name: Benchmark PR
        run: go test -bench=. -benchmem -count=6 -timeout=5m ./internal/transform/ | tee /tmp/bench-pr.txt

      - name: Checkout base
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.base.sha }}

      - name: Benchmark base
        run: go test -bench=. -benchmem -count=6 -timeout=5m ./internal/transform/ 2>&1 | tee /tmp/bench-base.txt || true

      - name: Compare benchmarks
        run: |
          go install golang.org/x/perf/cmd/benchstat@latest
          echo '## Benchmark comparison (base â†’ PR)' >> "$GITHUB_STEP_SUMMARY"
          echo '' >> "$GITHUB_STEP_SUMMARY"
          if ! grep -q '^Benchmark' /tmp/bench-base.txt 2>/dev/null; then
            echo 'No benchmarks in base branch. PR results:' >> "$GITHUB_STEP_SUMMARY"
            echo '' >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            grep '^Benchmark' /tmp/bench-pr.txt >> "$GITHUB_STEP_SUMMARY" || true
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          else
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            benchstat /tmp/bench-base.txt /tmp/bench-pr.txt >> "$GITHUB_STEP_SUMMARY" 2>&1
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi
